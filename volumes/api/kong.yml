_format_version: '2.1'
_transform: true

###
### Consumers and Credentials
###
consumers:
  - username: n8n_user
    basicauth_credentials:
      - username: ${N8N_BASIC_AUTH_USER}
        password: ${N8N_BASIC_AUTH_PASSWORD}
  - username: dashboard_user
    basicauth_credentials:
      - username: ${DASHBOARD_USERNAME}
        password: ${DASHBOARD_PASSWORD}

###
### API Routes
###
services:
  ## Open Auth routes
  - name: auth-v1-open
    url: http://supabase-auth:9999/verify
    routes:
      - name: auth-v1-open
        strip_path: true
        paths:
          - /auth/v1/verify
    plugins:
      - name: cors
  - name: auth-v1-open-callback
    url: http://supabase-auth:9999/callback
    routes:
      - name: auth-v1-open-callback
        strip_path: true
        paths:
          - /auth/v1/callback
    plugins:
      - name: cors
  - name: auth-v1-open-authorize
    url: http://supabase-auth:9999/authorize
    routes:
      - name: auth-v1-open-authorize
        strip_path: true
        paths:
          - /auth/v1/authorize
    plugins:
      - name: cors

  ## Secure Auth routes
  - name: auth-v1
    url: http://supabase-auth:9999/
    routes:
      - name: auth-v1-all
        strip_path: true
        paths:
          - /auth/v1/
    plugins:
      - name: cors
      # - name: key-auth
      #   config:
      #     hide_credentials: false
      # - name: acl
      #   config:
      #     hide_groups_header: true
      #     allow:
      #       - admin
      #       - anon

  ## Secure REST routes
  - name: rest-v1
    url: http://supabase-api:3000/
    routes:
      - name: rest-v1-all
        strip_path: true
        paths:
          - /rest/v1/
    plugins:
      - name: cors
      # - name: key-auth
      #   config:
      #     hide_credentials: true
      # - name: acl
      #   config:
      #     hide_groups_header: true
      #     allow:
      #       - admin
      #       - anon

  ## Secure GraphQL routes
  - name: graphql-v1
    url: http://supabase-api:3000/rpc/graphql
    routes:
      - name: graphql-v1-all
        strip_path: true
        paths:
          - /graphql/v1
    plugins:
      - name: cors
      - name: key-auth
        config:
          hide_credentials: true
      - name: request-transformer
        config:
          add:
            headers:
              - Content-Profile:graphql_public
      # - name: acl
      #   config:
      #     hide_groups_header: true
      #     allow:
      #       - admin
      #       - anon

  ## Secure Realtime routes
  - name: realtime-v1-ws
    url: http://supabase-realtime:4000/socket
    protocol: ws
    routes:
      - name: realtime-v1-ws
        strip_path: true
        paths:
          - /realtime/v1/
    plugins:
      - name: cors
      # - name: key-auth
      #   config:
      #     hide_credentials: false
      # - name: acl
      #   config:
      #     hide_groups_header: true
      #     allow:
      #       - admin
      #       - anon
  - name: realtime-v1-rest
    url: http://supabase-realtime:4000/api
    protocol: http
    routes:
      - name: realtime-v1-rest
        strip_path: true
        paths:
          - /realtime/v1/api
    plugins:
      - name: cors
      # - name: key-auth
      #   config:
      #     hide_credentials: false
      # - name: acl
      #   config:
      #     hide_groups_header: true
      #     allow:
      #       - admin
      #       - anon
  ## Storage routes: the storage server manages its own auth
  - name: storage-v1
    url: http://supabase-storage:5000/
    routes:
      - name: storage-v1-all
        strip_path: true
        paths:
          - /storage/v1/
    plugins:
      - name: cors

  ## Edge Functions routes
  - name: functions-v1
    url: http://functions:9000/
    routes:
      - name: functions-v1-all
        strip_path: true
        paths:
          - /functions/v1/
    plugins:
      - name: cors

  ## Analytics routes
  - name: analytics-v1
    url: http://analytics:4000/
    routes:
      - name: analytics-v1-all
        strip_path: true
        paths:
          - /analytics/v1/

  ## Secure Database routes
  - name: meta
    url: http://supabase-meta:8080/
    routes:
      - name: meta-all
        strip_path: true
        paths:
          - /pg/
    plugins: []
      # - name: key-auth
      #   config:
      #     hide_credentials: false
      # - name: acl
      #   config:
      #     hide_groups_header: true
      #     allow:
      #       - admin

  ## Backend API routes - Domain-based routing
  - name: backend-api
    url: http://backend:8000/
    routes:
      - name: backend-api-all
        strip_path: false
        hosts:
          - api.localhost
    plugins:
      - name: cors # Add basic CORS, can be customized further

  ## n8n routes - Domain-based routing with N8N_PROXY_HOPS=1 for proper asset loading
  - name: n8n-api
    url: http://n8n:5678/
    routes:
      - name: n8n-api-all
        strip_path: false
        hosts:
          - n8n.localhost
    plugins:
      - name: cors

  ## SearxNG routes - Domain-based routing
  - name: searxng-api
    url: http://searxng:8080/
    routes:
      - name: searxng-api-all
        strip_path: false
        hosts:
          - search.localhost
    plugins:
      - name: cors
      - name: rate-limiting
        config:
          minute: 60     # Allow 60 searches per minute
          hour: 1000     # Allow 1000 searches per hour
          policy: local
      # Note: SearxNG doesn't have built-in auth, add basic-auth if needed in production

  ## ComfyUI routes - Domain-based routing
  - name: comfyui-api
    url: http://comfyui:18188/
    routes:
      - name: comfyui-api-all
        strip_path: false
        hosts:
          - comfyui.localhost
    plugins:
      - name: cors
      # Note: ComfyUI doesn't have built-in auth, consider adding basic-auth if needed in production

  ## Open WebUI routes - Domain-based routing
  - name: openwebui-api
    url: http://open-web-ui:8080/
    routes:
      - name: openwebui-api-all
        strip_path: false
        hosts:
          - chat.localhost
    plugins:
      - name: cors
      # Note: Open WebUI has its own authentication system

  ## Protected Dashboard - catch all remaining routes
  - name: dashboard
    url: http://supabase-studio:3000/
    routes:
      - name: dashboard-all
        strip_path: true
        paths:
          - /
    plugins:
      - name: cors
      # Commenting out basic-auth to troubleshoot authentication issues
      # - name: basic-auth
      #   config:
      #     hide_credentials: true
